<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kanban Board Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: #0d1117;
        color: #c9d1d9;
        min-height: 100vh;
        padding: 1.25rem;
      }

      .header {
        text-align: center;
        margin-bottom: 1.875rem;
        padding-bottom: 1.25rem;
        border-bottom: 1px solid #30363d;
      }

      .header h1 {
        font-size: 1.8rem;
        color: #58a6ff;
        margin-bottom: 0.5rem;
      }

      .header p {
        color: #8b949e;
        font-size: 0.9rem;
      }

      .stats {
        display: flex;
        justify-content: center;
        gap: 1.875rem;
        margin-top: 0.9375rem;
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
      }

      .stat-label {
        font-size: 0.75rem;
        color: #8b949e;
        text-transform: uppercase;
      }

      .stat-pending .stat-value {
        color: #8b949e;
      }

      .stat-progress .stat-value {
        color: #f0883e;
      }

      .stat-review .stat-value {
        color: #a371f7;
      }

      .stat-completed .stat-value {
        color: #3fb950;
      }

      .stat-blocked .stat-value {
        color: #f85149;
      }

      .board {
        display: flex;
        gap: 1rem;
        width: 100%;
        overflow-x: auto;
      }

      .board.has-maximized {
        display: block;
      }

      .column {
        background: #161b22;
        border-radius: 12px;
        padding: 1rem;
        min-height: 31.25rem;
        min-width: 17.5rem;
        flex: 1;
        transition: all 0.3s ease;
      }

      .column.minimized {
        min-width: 2.5rem;
        width: 2.5rem;
        max-width: 2.5rem;
        flex: 0 0 2.5rem;
        padding: 0.5rem;
        cursor: pointer;
        position: relative;
      }

      .column.minimized:hover {
        background: #1c2128;
      }

      .column.minimized .column-header {
        display: flex;
        flex-direction: row;
        align-items: center;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
        border-bottom: none;
        padding-bottom: 0;
        height: auto;
        gap: 0.5rem;
      }

      .column.minimized .column-title {
        font-size: 0.7rem;
        letter-spacing: 0.0625rem;
        white-space: nowrap;
      }

      .column.minimized .column-count {
        position: static;
        transform: rotate(180deg);
        width: 1.25rem;
        height: 1.25rem;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.7rem;
        margin: 0;
        writing-mode: horizontal-tb;
      }

      .column.minimized .column-controls {
        display: none;
      }

      .column.minimized .tasks {
        display: none;
      }

      .column.hidden {
        display: none;
      }

      .column.maximized {
        min-width: 100%;
        width: 100%;
      }

      .column.maximized .tasks {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(21.875rem, 1fr));
        gap: 1rem;
      }

      .column.maximized .minimize-btn {
        display: none;
      }

      .column-header {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #30363d;
      }

      .column-title {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03125rem;
      }

      .column-count {
        background: #30363d;
        width: 1.5rem;
        height: 1.5rem;
        padding: 0;
        border-radius: 50%;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .column-controls {
        display: flex;
        gap: 0.375rem;
        margin-left: auto;
      }

      .control-btn {
        width: 1.75rem;
        height: 1.75rem;
        border: 1px solid #30363d;
        background: #21262d;
        color: #8b949e;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 0;
      }

      .control-btn svg {
        width: 0.875rem;
        height: 0.875rem;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
      }

      .control-btn:hover {
        background: #30363d;
        color: #c9d1d9;
        border-color: #58a6ff;
      }

      .control-btn.active {
        background: #58a6ff;
        color: #0d1117;
        border-color: #58a6ff;
      }

      .column-pending .column-title {
        color: #8b949e;
      }

      .column-progress .column-title {
        color: #f0883e;
      }

      .column-review .column-title {
        color: #a371f7;
      }

      .column-completed .column-title {
        color: #3fb950;
      }

      .column-blocked .column-title {
        color: #f85149;
      }

      .tasks {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .task {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .task:hover {
        border-color: #58a6ff;
        transform: translateY(-2px);
      }

      .task.expanded .task-description {
        display: block;
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
      }

      .task-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #c9d1d9;
        line-height: 1.3;
        font-family: monospace;
      }

      .task-category {
        font-size: 0.65rem;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-weight: 600;
        flex-shrink: 0;
        margin-left: 0.5rem;
        text-transform: uppercase;
      }

      .category-data {
        background: #238636;
        color: #fff;
      }

      .category-api {
        background: #1f6feb;
        color: #fff;
      }

      .category-ui {
        background: #a371f7;
        color: #fff;
      }

      .category-integration {
        background: #f0883e;
        color: #fff;
      }

      .category-config {
        background: #d29922;
        color: #fff;
      }

      .category-testing {
        background: #8b949e;
        color: #fff;
      }

      .task-description {
        font-size: 0.8rem;
        color: #8b949e;
        margin-bottom: 0.625rem;
        line-height: 1.5;
        display: none;
        background: #161b22;
        padding: 0.625rem;
        border-radius: 6px;
        border: 1px solid #30363d;
        max-height: 18.75rem;
        overflow-y: auto;
      }

      .task-steps {
        margin-top: 0.625rem;
        padding-top: 0.625rem;
        border-top: 1px solid #30363d;
      }

      .task-steps-label {
        font-size: 0.7rem;
        color: #6e7681;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
      }

      .task-step {
        font-size: 0.75rem;
        color: #8b949e;
        padding: 0.25rem 0;
        padding-left: 1rem;
        position: relative;
      }

      .task-step::before {
        content: '';
        position: absolute;
        left: 0;
        top: 8px;
        width: 8px;
        height: 8px;
        border: 1px solid #30363d;
        border-radius: 2px;
      }

      .task.completed .task-step::before {
        background: #3fb950;
        border-color: #3fb950;
      }

      .task-affected-files {
        margin-top: 0.625rem;
        padding-top: 0.625rem;
        border-top: 1px solid #30363d;
      }

      .task-affected-files-label {
        font-size: 0.7rem;
        color: #6e7681;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
      }

      .task-affected-file {
        font-size: 0.75rem;
        color: #58a6ff;
        padding: 0.1875rem 0;
        padding-left: 1rem;
        position: relative;
        font-family: monospace;
        word-break: break-all;
      }

      .task-affected-file::before {
        content: '';
        position: absolute;
        left: 2px;
        top: 8px;
        width: 6px;
        height: 6px;
        background: #58a6ff;
        border-radius: 50%;
      }

      .task-agents {
        margin-top: 0.625rem;
        padding-top: 0.625rem;
        border-top: 1px solid #30363d;
      }

      .task-agents-label {
        font-size: 0.7rem;
        color: #6e7681;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
      }

      .task-agents-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
      }

      .task-agent {
        font-size: 0.7rem;
        color: #f0883e;
        background: rgba(240, 136, 62, 0.15);
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-family: monospace;
      }

      .task-log {
        display: none;
        margin-top: 0.625rem;
        padding-top: 0.625rem;
        border-top: 1px solid #30363d;
      }

      .task.expanded .task-log {
        display: block;
      }

      .task-log-label {
        font-size: 0.7rem;
        color: #3fb950;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
        font-weight: 600;
      }

      .task-log-content {
        font-size: 0.8rem;
        color: #8b949e;
        line-height: 1.5;
        background: #161b22;
        padding: 0.625rem;
        border-radius: 6px;
        border: 1px solid #238636;
        max-height: 15.625rem;
        overflow-y: auto;
      }

      .refresh-indicator {
        position: fixed;
        bottom: 1.25rem;
        right: 1.25rem;
        background: #21262d;
        border: 1px solid #30363d;
        padding: 0.625rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        color: #8b949e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-circle {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #8b949e;
        transition: background-color 0.3s ease;
        flex-shrink: 0;
      }

      .status-circle.connected {
        background: #58a6ff;
      }

      .status-circle.disconnected {
        background: #f85149;
      }

      .empty-column {
        text-align: center;
        padding: 2.5rem 1.25rem;
        color: #6e7681;
        font-size: 0.85rem;
      }

      .progress-bar {
        width: 100%;
        height: 0.5rem;
        background: #21262d;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.9375rem;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3fb950, #58a6ff);
        transition: width 0.5s ease;
      }

      .error-message {
        text-align: center;
        padding: 2.5rem;
        color: #f85149;
        font-size: 1rem;
      }

      @media (max-width: 1400px) {
        .board {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 1000px) {
        .board {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .board {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1 id="project-title">Loading...</h1>
      <p id="project-type"></p>
      <div class="stats">
        <div class="stat stat-pending">
          <div class="stat-value" id="stat-pending">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat stat-blocked">
          <div class="stat-value" id="stat-blocked">0</div>
          <div class="stat-label">Blocked</div>
        </div>
        <div class="stat stat-progress">
          <div class="stat-value" id="stat-progress">0</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat stat-review">
          <div class="stat-value" id="stat-review">0</div>
          <div class="stat-label">Code Review</div>
        </div>
        <div class="stat stat-completed">
          <div class="stat-value" id="stat-completed">0</div>
          <div class="stat-label">Completed</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <div class="board">
      <div
        class="column column-pending"
        data-column="pending"
        onclick="handleColumnClick(event, this)"
      >
        <div class="column-header">
          <span class="column-title">Pending</span>
          <span class="column-count" id="count-pending">0</span>
          <div class="column-controls">
            <button
              class="control-btn minimize-btn"
              title="Minimize"
              onclick="toggleMinimize(event, 'pending')"
            >
              <svg viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
            <button
              class="control-btn maximize-btn"
              title="Maximize"
              onclick="toggleMaximize(event, 'pending')"
            >
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="tasks" id="tasks-pending"></div>
      </div>

      <div
        class="column column-blocked"
        data-column="blocked"
        onclick="handleColumnClick(event, this)"
      >
        <div class="column-header">
          <span class="column-title">Blocked</span>
          <span class="column-count" id="count-blocked">0</span>
          <div class="column-controls">
            <button
              class="control-btn minimize-btn"
              title="Minimize"
              onclick="toggleMinimize(event, 'blocked')"
            >
              <svg viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
            <button
              class="control-btn maximize-btn"
              title="Maximize"
              onclick="toggleMaximize(event, 'blocked')"
            >
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="tasks" id="tasks-blocked"></div>
      </div>

      <div
        class="column column-progress"
        data-column="progress"
        onclick="handleColumnClick(event, this)"
      >
        <div class="column-header">
          <span class="column-title">In Progress</span>
          <span class="column-count" id="count-progress">0</span>
          <div class="column-controls">
            <button
              class="control-btn minimize-btn"
              title="Minimize"
              onclick="toggleMinimize(event, 'progress')"
            >
              <svg viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
            <button
              class="control-btn maximize-btn"
              title="Maximize"
              onclick="toggleMaximize(event, 'progress')"
            >
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="tasks" id="tasks-progress"></div>
      </div>

      <div
        class="column column-review"
        data-column="review"
        onclick="handleColumnClick(event, this)"
      >
        <div class="column-header">
          <span class="column-title">Code Review</span>
          <span class="column-count" id="count-review">0</span>
          <div class="column-controls">
            <button
              class="control-btn minimize-btn"
              title="Minimize"
              onclick="toggleMinimize(event, 'review')"
            >
              <svg viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
            <button
              class="control-btn maximize-btn"
              title="Maximize"
              onclick="toggleMaximize(event, 'review')"
            >
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="tasks" id="tasks-review"></div>
      </div>

      <div
        class="column column-completed"
        data-column="completed"
        onclick="handleColumnClick(event, this)"
      >
        <div class="column-header">
          <span class="column-title">Completed</span>
          <span class="column-count" id="count-completed">0</span>
          <div class="column-controls">
            <button
              class="control-btn minimize-btn"
              title="Minimize"
              onclick="toggleMinimize(event, 'completed')"
            >
              <svg viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
            <button
              class="control-btn maximize-btn"
              title="Maximize"
              onclick="toggleMaximize(event, 'completed')"
            >
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="tasks" id="tasks-completed"></div>
      </div>
    </div>

    <div class="refresh-indicator">
      <span>Status:</span>
      <div class="status-circle" id="status-circle"></div>
    </div>

    <script>
      let lastBoardData = null;
      let lastProgressData = null;
      let maximizedColumn = null;

      const COLUMN_STATE_KEY = 'kanban-column-state';

      function getColumnState() {
        try {
          const state = localStorage.getItem(COLUMN_STATE_KEY);
          return state ? JSON.parse(state) : { minimized: [], maximized: null };
        } catch {
          return { minimized: [], maximized: null };
        }
      }

      function saveColumnState(minimized, maximized) {
        try {
          localStorage.setItem(
            COLUMN_STATE_KEY,
            JSON.stringify({ minimized, maximized })
          );
        } catch {
          // localStorage not available
        }
      }

      function toggleMinimize(event, columnId) {
        event.stopPropagation();
        const column = document.querySelector(`[data-column="${columnId}"]`);
        if (!column) return;

        // If maximized, exit maximize mode first
        if (maximizedColumn) {
          exitMaximizeMode();
        }

        const isMinimized = column.classList.toggle('minimized');
        const state = getColumnState();

        if (isMinimized) {
          if (!state.minimized.includes(columnId)) {
            state.minimized.push(columnId);
          }
        } else {
          state.minimized = state.minimized.filter((id) => id !== columnId);
        }

        saveColumnState(state.minimized, state.maximized);
      }

      function toggleMaximize(event, columnId) {
        event.stopPropagation();
        const column = document.querySelector(`[data-column="${columnId}"]`);
        if (!column) return;

        const board = document.querySelector('.board');
        const allColumns = document.querySelectorAll('.column');

        if (maximizedColumn === columnId) {
          // Exit maximize mode
          exitMaximizeMode();
        } else {
          // Enter maximize mode
          maximizedColumn = columnId;
          board.classList.add('has-maximized');

          allColumns.forEach((col) => {
            const colId = col.dataset.column;
            if (colId === columnId) {
              col.classList.remove('minimized', 'hidden');
              col.classList.add('maximized');
              // Update button to show close icon
              const maxBtn = col.querySelector('.maximize-btn');
              if (maxBtn) {
                maxBtn.innerHTML =
                  '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                maxBtn.title = 'Restore';
                maxBtn.classList.add('active');
              }
            } else {
              col.classList.add('hidden');
            }
          });

          const state = getColumnState();
          state.maximized = columnId;
          saveColumnState(state.minimized, state.maximized);
        }
      }

      function exitMaximizeMode() {
        const board = document.querySelector('.board');
        const allColumns = document.querySelectorAll('.column');
        const state = getColumnState();

        board.classList.remove('has-maximized');
        maximizedColumn = null;

        allColumns.forEach((col) => {
          const colId = col.dataset.column;
          col.classList.remove('maximized', 'hidden');

          // Restore minimized state if it was minimized before
          if (state.minimized.includes(colId)) {
            col.classList.add('minimized');
          }

          // Reset maximize button
          const maxBtn = col.querySelector('.maximize-btn');
          if (maxBtn) {
            maxBtn.innerHTML =
              '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>';
            maxBtn.title = 'Maximize';
            maxBtn.classList.remove('active');
          }
        });

        state.maximized = null;
        saveColumnState(state.minimized, state.maximized);
      }

      function handleColumnClick(event, column) {
        // Only restore if column is minimized and click is not on a button or task
        if (column.classList.contains('minimized')) {
          const isButton = event.target.closest('.control-btn');
          const isTask = event.target.closest('.task');
          if (!isButton && !isTask) {
            const columnId = column.dataset.column;
            toggleMinimize(event, columnId);
          }
        }
      }

      function restoreColumnState() {
        const state = getColumnState();

        // Restore minimized columns
        state.minimized.forEach((columnId) => {
          const column = document.querySelector(`[data-column="${columnId}"]`);
          if (column) {
            column.classList.add('minimized');
          }
        });

        // Restore maximized column
        if (state.maximized) {
          const fakeEvent = {
            stopPropagation: () => {},
          };
          toggleMaximize(fakeEvent, state.maximized);
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function parseMarkdown(text) {
        if (!text) return '';

        let html = escapeHtml(text);

        // Headers (h1-h3)
        html = html.replace(
          /^### (.+)$/gm,
          '<h4 style="color:#c9d1d9;margin:8px 0 4px;font-size:0.85rem;">$1</h4>'
        );
        html = html.replace(
          /^## (.+)$/gm,
          '<h3 style="color:#c9d1d9;margin:10px 0 6px;font-size:0.9rem;">$1</h3>'
        );
        html = html.replace(
          /^# (.+)$/gm,
          '<h2 style="color:#c9d1d9;margin:12px 0 8px;font-size:1rem;">$1</h2>'
        );

        // Bold and italic
        html = html.replace(
          /\*\*\*(.+?)\*\*\*/g,
          '<strong><em>$1</em></strong>'
        );
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
        html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
        html = html.replace(/_(.+?)_/g, '<em>$1</em>');

        // Code blocks (fenced) - MUST run before inline code to avoid partial matches
        html = html.replace(
          /```(\w*)\s*([\s\S]*?)```/g,
          '<pre style="background:#0d1117;padding:10px;border-radius:6px;overflow-x:auto;margin:8px 0;"><code>$2</code></pre>'
        );

        // Inline code (after code blocks)
        html = html.replace(
          /`([^`]+)`/g,
          '<code style="background:#30363d;padding:2px 6px;border-radius:4px;font-size:0.8rem;">$1</code>'
        );

        // Unordered lists
        html = html.replace(
          /^[-*] (.+)$/gm,
          '<li style="margin-left:16px;list-style:disc;">$1</li>'
        );

        // Ordered lists (simple)
        html = html.replace(
          /^\d+\. (.+)$/gm,
          '<li style="margin-left:16px;list-style:decimal;">$1</li>'
        );

        // Wrap consecutive list items
        html = html.replace(
          /(<li[^>]*>.*<\/li>\n?)+/g,
          '<ul style="margin:4px 0;padding-left:8px;">$&</ul>'
        );

        // Links
        html = html.replace(
          /\[([^\]]+)\]\(([^)]+)\)/g,
          '<a href="$2" style="color:#58a6ff;text-decoration:none;" target="_blank">$1</a>'
        );

        // Horizontal rules
        html = html.replace(
          /^[-*_]{3,}$/gm,
          '<hr style="border:none;border-top:1px solid #30363d;margin:10px 0;">'
        );

        // Blockquotes
        html = html.replace(
          /^&gt; (.+)$/gm,
          '<blockquote style="border-left:3px solid #30363d;padding-left:12px;color:#8b949e;margin:8px 0;">$1</blockquote>'
        );

        // Paragraphs - convert double newlines to paragraph breaks, single newlines to spaces
        html = html.replace(/\n\n+/g, '</p><p style="margin:8px 0;">');
        html = html.replace(/\n/g, ' ');
        html = '<p style="margin:8px 0;">' + html + '</p>';

        return html;
      }

      // Status logic:
      // - passes === true AND progress.status === 'completed' → completed
      // - passes === true AND progress.status !== 'completed' → code-review (awaiting commit)
      // - passes === false AND progress.status === 'blocked' → blocked
      // - passes === false AND in progress file → in-progress
      // - Not in progress file → pending
      function getTaskStatus(task, progressData) {
        const progress = progressData[task.name];
        const isStarted = !!progress;
        const isPassed = task.passes === true;
        const progressStatus = progress?.status;

        if (isPassed && progressStatus === 'completed') {
          return 'completed';
        }
        if (isPassed) {
          return 'code-review';
        }
        if (task.status === 'code-review') {
          return 'code-review';
        }
        if (progressStatus === 'blocked') {
          return 'blocked';
        }
        if (isStarted) {
          return 'in-progress';
        }
        return 'pending';
      }

      function createTaskCard(task, status, progressEntry) {
        const stepsHtml =
          task.steps && task.steps.length > 0
            ? `
        <div class="task-steps">
          <div class="task-steps-label">Verification Steps:</div>
          ${task.steps.map((s) => `<div class="task-step">${escapeHtml(s)}</div>`).join('')}
        </div>
      `
            : '';

        const affectedFiles = progressEntry?.affectedFiles || [];
        const affectedFilesHtml =
          affectedFiles.length > 0
            ? `
        <div class="task-affected-files">
          <div class="task-affected-files-label">Affected Files (${affectedFiles.length}):</div>
          ${affectedFiles.map((f) => `<div class="task-affected-file">${escapeHtml(f)}</div>`).join('')}
        </div>
      `
            : '';

        const agents = progressEntry?.agents || [];
        const agentsHtml =
          agents.length > 0
            ? `
        <div class="task-agents">
          <div class="task-agents-label">Agents (${agents.length}):</div>
          <div class="task-agents-list">
            ${agents.map((a) => `<span class="task-agent">${escapeHtml(a)}</span>`).join('')}
          </div>
        </div>
      `
            : '';

        const log = progressEntry?.log || '';
        const logHtml = log
          ? `
        <div class="task-log">
          <div class="task-log-label">Work Log:</div>
          <div class="task-log-content">${parseMarkdown(log)}</div>
        </div>
      `
          : '';

        const completedClass = status === 'completed' ? 'completed' : '';

        return `
        <div class="task ${completedClass}" onclick="this.classList.toggle('expanded')">
          <div class="task-header">
            <span class="task-name">${escapeHtml(task.name)}</span>
            <span class="task-category category-${task.category}">${escapeHtml(task.category)}</span>
          </div>
          <div class="task-description">${parseMarkdown(task.description || '')}</div>
          ${logHtml}
          ${stepsHtml}
          ${affectedFilesHtml}
          ${agentsHtml}
        </div>
      `;
      }

      function renderBoard(boardData, progressData) {
        const tasks = boardData.tasks || [];
        const progressObj = progressData || {};

        // Categorize tasks by status
        const pending = [];
        const blocked = [];
        const inProgress = [];
        const codeReview = [];
        const completed = [];

        tasks.forEach((task) => {
          const status = getTaskStatus(task, progressObj);
          switch (status) {
            case 'pending':
              pending.push(task);
              break;
            case 'blocked':
              blocked.push(task);
              break;
            case 'in-progress':
              inProgress.push(task);
              break;
            case 'code-review':
              codeReview.push(task);
              break;
            case 'completed':
              completed.push(task);
              break;
          }
        });

        // Update header
        document.getElementById('project-title').textContent =
          boardData.project || 'Kanban Board';
        document.getElementById('project-type').textContent =
          boardData.projectType ? `Project Type: ${boardData.projectType}` : '';

        // Update stats
        document.getElementById('stat-pending').textContent = pending.length;
        document.getElementById('stat-blocked').textContent = blocked.length;
        document.getElementById('stat-progress').textContent =
          inProgress.length;
        document.getElementById('stat-review').textContent = codeReview.length;
        document.getElementById('stat-completed').textContent =
          completed.length;

        // Update counts
        document.getElementById('count-pending').textContent = pending.length;
        document.getElementById('count-blocked').textContent = blocked.length;
        document.getElementById('count-progress').textContent =
          inProgress.length;
        document.getElementById('count-review').textContent = codeReview.length;
        document.getElementById('count-completed').textContent =
          completed.length;

        // Update progress bar
        const total = tasks.length;
        const progressPercent =
          total > 0 ? (completed.length / total) * 100 : 0;
        document.getElementById('progress-fill').style.width =
          `${progressPercent}%`;

        // Render tasks
        document.getElementById('tasks-pending').innerHTML =
          pending.length > 0
            ? pending
                .map((t) => createTaskCard(t, 'pending', progressObj[t.name]))
                .join('')
            : '<div class="empty-column">No pending tasks</div>';

        document.getElementById('tasks-blocked').innerHTML =
          blocked.length > 0
            ? blocked
                .map((t) => createTaskCard(t, 'blocked', progressObj[t.name]))
                .join('')
            : '<div class="empty-column">No blocked tasks</div>';

        document.getElementById('tasks-progress').innerHTML =
          inProgress.length > 0
            ? inProgress
                .map((t) =>
                  createTaskCard(t, 'in-progress', progressObj[t.name])
                )
                .join('')
            : '<div class="empty-column">No tasks in progress</div>';

        document.getElementById('tasks-review').innerHTML =
          codeReview.length > 0
            ? codeReview
                .map((t) =>
                  createTaskCard(t, 'code-review', progressObj[t.name])
                )
                .join('')
            : '<div class="empty-column">No tasks in review</div>';

        document.getElementById('tasks-completed').innerHTML =
          completed.length > 0
            ? completed
                .map((t) => createTaskCard(t, 'completed', progressObj[t.name]))
                .join('')
            : '<div class="empty-column">No completed tasks</div>';
      }

      function setStatus(connected) {
        const circle = document.getElementById('status-circle');
        circle.classList.remove('connected', 'disconnected');
        circle.classList.add(connected ? 'connected' : 'disconnected');
      }

      async function fetchAndRender() {
        try {
          // Fetch both files
          const [boardResponse, progressResponse] = await Promise.all([
            fetch('/.kanban/kanban-board.json?' + Date.now()),
            fetch('/.kanban/kanban-progress.json?' + Date.now()),
          ]);

          if (!boardResponse.ok) {
            throw new Error('Failed to fetch kanban-board.json');
          }

          const boardData = await boardResponse.json();
          let progressData = {};

          if (progressResponse.ok) {
            progressData = await progressResponse.json();
          }

          const boardStr = JSON.stringify(boardData);
          const progressStr = JSON.stringify(progressData);

          if (boardStr !== lastBoardData || progressStr !== lastProgressData) {
            lastBoardData = boardStr;
            lastProgressData = progressStr;
            renderBoard(boardData, progressData);
          }

          setStatus(true);
        } catch (err) {
          setStatus(false);
          console.error('Fetch error:', err);

          // Show error in board
          document.getElementById('project-title').textContent =
            'Error Loading Kanban';
          document.getElementById('tasks-pending').innerHTML =
            '<div class="error-message">Could not load .kanban/kanban-board.json<br>Run /kanban:create first</div>';
        }
      }

      // Initial load
      fetchAndRender();

      // Restore column state from localStorage
      restoreColumnState();

      // Auto-refresh every 1 second
      setInterval(fetchAndRender, 1000);
    </script>
  </body>
</html>
