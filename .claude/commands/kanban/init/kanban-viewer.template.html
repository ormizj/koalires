<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        .header h1 {
            font-size: 1.8rem;
            color: #58a6ff;
            margin-bottom: 8px;
        }

        .header p {
            color: #8b949e;
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #8b949e;
            text-transform: uppercase;
        }

        .stat-pending .stat-value {
            color: #8b949e;
        }

        .stat-progress .stat-value {
            color: #f0883e;
        }

        .stat-review .stat-value {
            color: #a371f7;
        }

        .stat-completed .stat-value {
            color: #3fb950;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .column {
            background: #161b22;
            border-radius: 12px;
            padding: 16px;
            min-height: 500px;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }

        .column-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .column-count {
            background: #30363d;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .column-pending .column-title {
            color: #8b949e;
        }

        .column-progress .column-title {
            color: #f0883e;
        }

        .column-review .column-title {
            color: #a371f7;
        }

        .column-completed .column-title {
            color: #3fb950;
        }

        .tasks {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }

        .task.expanded .task-description {
            display: block;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #c9d1d9;
            line-height: 1.3;
            font-family: monospace;
        }

        .task-category {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            flex-shrink: 0;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .category-data {
            background: #238636;
            color: #fff;
        }

        .category-api {
            background: #1f6feb;
            color: #fff;
        }

        .category-ui {
            background: #a371f7;
            color: #fff;
        }

        .category-integration {
            background: #f0883e;
            color: #fff;
        }

        .category-config {
            background: #d29922;
            color: #fff;
        }

        .category-testing {
            background: #8b949e;
            color: #fff;
        }

        .task-description {
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 10px;
            line-height: 1.5;
            display: none;
            background: #161b22;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
        }

        .task-steps {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #30363d;
        }

        .task-steps-label {
            font-size: 0.7rem;
            color: #6e7681;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .task-step {
            font-size: 0.75rem;
            color: #8b949e;
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        .task-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 8px;
            height: 8px;
            border: 1px solid #30363d;
            border-radius: 2px;
        }

        .task.completed .task-step::before {
            background: #3fb950;
            border-color: #3fb950;
        }

        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #21262d;
            border: 1px solid #30363d;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #8b949e;
        }

        .refresh-indicator.updating {
            color: #58a6ff;
        }

        .empty-column {
            text-align: center;
            padding: 40px 20px;
            color: #6e7681;
            font-size: 0.85rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3fb950, #58a6ff);
            transition: width 0.5s ease;
        }

        .error-message {
            text-align: center;
            padding: 40px;
            color: #f85149;
            font-size: 1rem;
        }

        @media (max-width: 1200px) {
            .board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1 id="project-title">Loading...</h1>
    <p id="project-type"></p>
    <div class="stats">
        <div class="stat stat-pending">
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat stat-progress">
            <div class="stat-value" id="stat-progress">0</div>
            <div class="stat-label">In Progress</div>
        </div>
        <div class="stat stat-review">
            <div class="stat-value" id="stat-review">0</div>
            <div class="stat-label">Code Review</div>
        </div>
        <div class="stat stat-completed">
            <div class="stat-value" id="stat-completed">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>
</div>

<div class="board">
    <div class="column column-pending">
        <div class="column-header">
            <span class="column-title">Pending</span>
            <span class="column-count" id="count-pending">0</span>
        </div>
        <div class="tasks" id="tasks-pending"></div>
    </div>

    <div class="column column-progress">
        <div class="column-header">
            <span class="column-title">In Progress</span>
            <span class="column-count" id="count-progress">0</span>
        </div>
        <div class="tasks" id="tasks-progress"></div>
    </div>

    <div class="column column-review">
        <div class="column-header">
            <span class="column-title">Code Review</span>
            <span class="column-count" id="count-review">0</span>
        </div>
        <div class="tasks" id="tasks-review"></div>
    </div>

    <div class="column column-completed">
        <div class="column-header">
            <span class="column-title">Completed</span>
            <span class="column-count" id="count-completed">0</span>
        </div>
        <div class="tasks" id="tasks-completed"></div>
    </div>
</div>

<div class="refresh-indicator" id="refresh-indicator">
    Auto-refresh: 1s
</div>

<script>
    let lastBoardData = null;
    let lastProgressData = null;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function parseMarkdown(text) {
        if (!text) return '';

        let html = escapeHtml(text);

        // Headers (h1-h3)
        html = html.replace(/^### (.+)$/gm, '<h4 style="color:#c9d1d9;margin:8px 0 4px;font-size:0.85rem;">$1</h4>');
        html = html.replace(/^## (.+)$/gm, '<h3 style="color:#c9d1d9;margin:10px 0 6px;font-size:0.9rem;">$1</h3>');
        html = html.replace(/^# (.+)$/gm, '<h2 style="color:#c9d1d9;margin:12px 0 8px;font-size:1rem;">$1</h2>');

        // Bold and italic
        html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
        html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
        html = html.replace(/_(.+?)_/g, '<em>$1</em>');

        // Code blocks (fenced) - MUST run before inline code to avoid partial matches
        html = html.replace(/```(\w*)\s*([\s\S]*?)```/g, '<pre style="background:#0d1117;padding:10px;border-radius:6px;overflow-x:auto;margin:8px 0;"><code>$2</code></pre>');

        // Inline code (after code blocks)
        html = html.replace(/`([^`]+)`/g, '<code style="background:#30363d;padding:2px 6px;border-radius:4px;font-size:0.8rem;">$1</code>');

        // Unordered lists
        html = html.replace(/^[-*] (.+)$/gm, '<li style="margin-left:16px;list-style:disc;">$1</li>');

        // Ordered lists (simple)
        html = html.replace(/^\d+\. (.+)$/gm, '<li style="margin-left:16px;list-style:decimal;">$1</li>');

        // Wrap consecutive list items
        html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul style="margin:4px 0;padding-left:8px;">$&</ul>');

        // Links
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color:#58a6ff;text-decoration:none;" target="_blank">$1</a>');

        // Horizontal rules
        html = html.replace(/^[-*_]{3,}$/gm, '<hr style="border:none;border-top:1px solid #30363d;margin:10px 0;">');

        // Blockquotes
        html = html.replace(/^&gt; (.+)$/gm, '<blockquote style="border-left:3px solid #30363d;padding-left:12px;color:#8b949e;margin:8px 0;">$1</blockquote>');

        // Paragraphs - convert double newlines to paragraph breaks, single newlines to spaces
        html = html.replace(/\n\n+/g, '</p><p style="margin:8px 0;">');
        html = html.replace(/\n/g, ' ');
        html = '<p style="margin:8px 0;">' + html + '</p>';

        return html;
    }

    // Status logic:
    // - passes === true → completed
    // - status === 'code-review' → code-review
    // - In started list but passes !== true → in-progress
    // - Not in started list → pending
    function getTaskStatus(task, startedTasks) {
        if (task.passes === true) {
            return 'completed';
        }
        if (task.status === 'code-review') {
            return 'code-review';
        }
        if (startedTasks.includes(task.name)) {
            return 'in-progress';
        }
        return 'pending';
    }

    function createTaskCard(task, status) {
        const stepsHtml = task.steps && task.steps.length > 0 ? `
        <div class="task-steps">
          <div class="task-steps-label">Verification Steps:</div>
          ${task.steps.map(s => `<div class="task-step">${escapeHtml(s)}</div>`).join('')}
        </div>
      ` : '';

        const completedClass = status === 'completed' ? 'completed' : '';

        return `
        <div class="task ${completedClass}" onclick="this.classList.toggle('expanded')">
          <div class="task-header">
            <span class="task-name">${escapeHtml(task.name)}</span>
            <span class="task-category category-${task.category}">${escapeHtml(task.category)}</span>
          </div>
          <div class="task-description">${parseMarkdown(task.description || '')}</div>
          ${stepsHtml}
        </div>
      `;
    }

    function renderBoard(boardData, progressData) {
        const tasks = boardData.tasks || [];
        // Progress is just an array of started task names
        const startedTasks = Array.isArray(progressData) ? progressData : [];

        // Categorize tasks by status
        const pending = [];
        const inProgress = [];
        const codeReview = [];
        const completed = [];

        tasks.forEach(task => {
            const status = getTaskStatus(task, startedTasks);
            switch (status) {
                case 'pending':
                    pending.push(task);
                    break;
                case 'in-progress':
                    inProgress.push(task);
                    break;
                case 'code-review':
                    codeReview.push(task);
                    break;
                case 'completed':
                    completed.push(task);
                    break;
            }
        });

        // Update header
        document.getElementById('project-title').textContent = boardData.project || 'Kanban Board';
        document.getElementById('project-type').textContent = boardData.projectType ? `Project Type: ${boardData.projectType}` : '';

        // Update stats
        document.getElementById('stat-pending').textContent = pending.length;
        document.getElementById('stat-progress').textContent = inProgress.length;
        document.getElementById('stat-review').textContent = codeReview.length;
        document.getElementById('stat-completed').textContent = completed.length;

        // Update counts
        document.getElementById('count-pending').textContent = pending.length;
        document.getElementById('count-progress').textContent = inProgress.length;
        document.getElementById('count-review').textContent = codeReview.length;
        document.getElementById('count-completed').textContent = completed.length;

        // Update progress bar
        const total = tasks.length;
        const progressPercent = total > 0 ? (completed.length / total) * 100 : 0;
        document.getElementById('progress-fill').style.width = `${progressPercent}%`;

        // Render tasks
        document.getElementById('tasks-pending').innerHTML =
            pending.length > 0
                ? pending.map(t => createTaskCard(t, 'pending')).join('')
                : '<div class="empty-column">No pending tasks</div>';

        document.getElementById('tasks-progress').innerHTML =
            inProgress.length > 0
                ? inProgress.map(t => createTaskCard(t, 'in-progress')).join('')
                : '<div class="empty-column">No tasks in progress</div>';

        document.getElementById('tasks-review').innerHTML =
            codeReview.length > 0
                ? codeReview.map(t => createTaskCard(t, 'code-review')).join('')
                : '<div class="empty-column">No tasks in review</div>';

        document.getElementById('tasks-completed').innerHTML =
            completed.length > 0
                ? completed.map(t => createTaskCard(t, 'completed')).join('')
                : '<div class="empty-column">No completed tasks</div>';
    }

    async function fetchAndRender() {
        const indicator = document.getElementById('refresh-indicator');

        try {
            indicator.classList.add('updating');
            indicator.textContent = 'Updating...';

            // Fetch both files
            const [boardResponse, progressResponse] = await Promise.all([
                fetch('/.kanban/kanban-board.json?' + Date.now()),
                fetch('/.kanban/kanban-progress.json?' + Date.now())
            ]);

            if (!boardResponse.ok) {
                throw new Error('Failed to fetch kanban-board.json');
            }

            const boardData = await boardResponse.json();
            let progressData = [];

            if (progressResponse.ok) {
                progressData = await progressResponse.json();
            }

            const boardStr = JSON.stringify(boardData);
            const progressStr = JSON.stringify(progressData);

            if (boardStr !== lastBoardData || progressStr !== lastProgressData) {
                lastBoardData = boardStr;
                lastProgressData = progressStr;
                renderBoard(boardData, progressData);
            }

            indicator.classList.remove('updating');
            indicator.textContent = 'Auto-refresh: 1s';
        } catch (err) {
            indicator.classList.remove('updating');
            indicator.textContent = 'Error loading data';
            console.error('Fetch error:', err);

            // Show error in board
            document.getElementById('project-title').textContent = 'Error Loading Kanban';
            document.getElementById('tasks-pending').innerHTML =
                '<div class="error-message">Could not load .kanban/kanban-board.json<br>Run /kanban:create first</div>';
        }
    }

    // Initial load
    fetchAndRender();

    // Auto-refresh every 1 second
    setInterval(fetchAndRender, 1000);
</script>
</body>
</html>